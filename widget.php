<?php

$FILE_SEPARATOR = ':: ';

$IMAGE = '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';

$style = array(
	'container'=>'width: 180px; height: auto; font-size:10px; background: #ffffff url(data:image/png;base64,'.$IMAGE.') no-repeat; overflow: hidden;',
	'header'=>'font-size:14px; margin:0; padding:0; padding-top: 39px;',
	'info1'=>'font-size:10px; margin:2px;',
	'info2'=>'font-size:8px; margin:2px; list-style-type: none; padding-left:6px;',
	'info3'=>'font-size:10px; margin:2px;'
);


function sep( $str ) {
	return explode(': ',str);
}

function get( $str ) {
	global $lins;
	foreach($lins as $l) {
		$p = explode(': ',$l);
		if ($p[0]==$str) return $p[1];           
	}
	return null;
}

function getTime( $t ) {
	return date('H:i:s d/m/y',$t);
}

function formatN( $str )
{
	$str = "$str";
	$r = "";
	$c = 0;
	for($i=strlen($str)-1; $i>=0; $i--) {
		$r = $str[$i] . $r;
		if ($c>=2 && $i>0) {
			$r = ".$r";
			$c = 0;
		}
		$c+=1;
	}
	return $r;
}

//obtem arquivo
$sumario = file_get_contents('sumario_online.log');
$lins = explode("\n", $sumario);

$info = array(
	'ultimoacesso' 		=> get('Hora do registro'),
	'totaldearquivos'	=> get('Total de arquivos'),
	'ultimototarq' 		=> get('Total de arquivos da ultima amostragem'),
	'novosarquivos' 	=> get('Arquivos novos'),
	'apagadarquivos' 	=> get('Arquivos apagados'),
	'totaldebytes' 		=> get('Total de bytes'),
	'modarquivos' 		=> get('Arquivos modificados')
);
$list = explode("Lista de arquivos modificados:\n", $sumario );
if (count($list)>1) {
	$list = explode( "\n", $list[1] );
	array_pop($list);
} else
	$list = array('nenhum');

$delay = time() - strtotime($info['ultimoacesso']);
$delay = floor( $delay / 3600 );
$d = floor($delay/24);
if ($delay>24) {
	$delay = $d . " dias e " . ($delay-$d*24) . " horas";
} else {
	$delay = $d . " horas";
}


echo '<'.'?xml version="1.0" encoding="UTF-8" ?'.">\n";
?><Module>
	<ModulePrefs title="Atividades do projeto" /> 
	<Content type="html">
	<![CDATA[
	<!-- Gadget create by Marcos Augusto Bitetti (marcosbitetti [at] gmail.com) -->
	<div id="wwp_monit_container" style="<?php echo $style['container']; ?>">
		<h1 id="wwp_monit_title" style="<?php echo $style['header']; ?>"></h1>
		<h4 style="<?php echo $style['info1']; ?>" title="A última vez que o projeto teve algum trabalho">Últimas estatisticas <b><?php echo $delay; ?> atráz</b></h4>
		<h4 style="<?php echo $style['info1']; ?>">Últimos arquivos trabalhados:</h4>
		<ul style="<?php echo $style['info2']; ?>">
			<?php foreach ($list as $arq => $dt) {
				$dt = explode($FILE_SEPARATOR,$dt);
				?>
				<li title="<?php echo getTime($dt[1]); ?>"><?php echo $dt[0]; ?></li>
			<?php } ?>
		</ul>
		<h4 style="<?php echo $style['info3']; ?>" title="">Novos arquivos <b><?php echo formatN($info['novosarquivos']); ?></b></h4>
		<h4 style="<?php echo $style['info3']; ?>" title="">Total de arquivos <b><?php echo formatN($info['totaldearquivos']); ?></b></h4>
		<h4 style="<?php echo $style['info3']; ?>" title="">Total de megabytes <b><?php echo formatN(round($info['totaldebytes']/1048576)); ?> MB</b></h4>
	</div>
	]]>
	</Content>
</Module>
